rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }

    function isManager() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'manager';
    }
    
    function isAssignedManager(projectId) {
      let projectData = get(/databases/$(database)/documents/projects/$(projectId)).data;
      return projectData.assigned_manager_id == request.auth.uid;
    }
    
    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    match /users/{userId} {
      // Admins can read all user docs. Users can read their own.
      allow get: if isAdmin() || isOwner(userId);
      allow list: if isAdmin();
      
      // Users can create their own doc. Role must be 'manager' by default.
      allow create: if isOwner(userId) && request.resource.data.role == 'manager';

      // Users can update their own doc, but cannot change their role. Admins can change anything.
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.role) || isAdmin();
      
      allow delete: if isAdmin();
    }

     match /projects/{projectId} {
      // Admins can perform any action on projects.
      allow write: if isAdmin();
      
      // Admins can get any project. Managers can only get projects they are assigned to.
      allow get: if isAdmin() || (isManager() && resource.data.assigned_manager_id == request.auth.uid);

      // Only admins are allowed to list all projects.
      // Managers must use a query with a 'where' clause on 'assigned_manager_id'.
      allow list: if isAdmin() || (isManager() && resource.data.assigned_manager_id == request.auth.uid);
    }
    
    match /workers/{workerId} {
        // Admins and managers can read worker data.
        allow read: if isAdmin() || isManager();
        // Only Admins can create, update, or delete workers.
        allow write: if isAdmin();

        match /transactions/{transactionId} {
            // Only admins can create and read payment transactions for a worker.
            allow read, write: if isAdmin();
        }
    }

    match /salary_payouts/{payoutId} {
        // Admins can create and view payout history.
        allow read, create: if isAdmin();
        allow update, delete: if isAdmin(); // Only admins can alter history
    }
    
    match /transactions/{transactionId} {
      // Only admins can manage global transactions
      allow read, write: if isAdmin();
    }
    
    match /projects/{projectId}/transactions/{transactionId} {
      // Admins can read all transactions. Managers can read transactions for their projects.
      allow read: if isAdmin() || (isManager() && isAssignedManager(projectId));
      
      // Managers can create transactions for their projects.
      allow create: if isManager() && isAssignedManager(projectId);
      
      // Only admins can delete transactions. Managers cannot update approved transactions.
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /projects/{projectId}/tasks/{taskId} {
      // Admins can create and delete tasks.
      allow create, delete: if isAdmin();
      
      // Admins and assigned managers can update tasks.
      allow update: if isAdmin() || (isManager() && isAssignedManager(projectId));
      
      // Admins and assigned managers can read tasks.
      allow get, list: if isAdmin() || (isManager() && isAssignedManager(projectId));
    }
    
    match /attendance/{attendanceId} {
      allow get: if isAdmin() || (isManager() && get(/databases/$(database)/documents/projects/$(resource.data.project_id)).data.assigned_manager_id == request.auth.uid);
      allow list: if isAdmin() || (isManager() && request.query.where.project_id == get(/databases/$(database)/documents/projects/$(request.query.where.project_id)).data.id && get(/databases/$(database)/documents/projects/$(request.query.where.project_id)).data.assigned_manager_id == request.auth.uid);
      allow create: if isManager();
      allow update, delete: if isAdmin();
    }
    
    // This rule allows admins to perform collection group queries on 'transactions' and 'tasks'.
    match /{path=**}/{collectionName}/{docId} {
        allow list: if (collectionName == 'transactions' || collectionName == 'tasks') && isAdmin();
    }
  }
}
